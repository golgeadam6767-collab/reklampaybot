<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ElmasToken â€¢ Reklam</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:#0f172a; color:#e2e8f0; }
    .wrap { max-width:520px; margin:0 auto; padding:14px 14px 24px 14px; }
    .card {
      background:#111827;
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 12px 24px rgba(0,0,0,.25);
    }
    .topbar {
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:#0b1220;
    }
    .title { font-weight:800; letter-spacing:.2px; }
    .pill {
      font-size:13px; font-weight:800;
      background:#fbbf24; color:#0b1220;
      padding:6px 10px; border-radius:999px;
      white-space:nowrap;
    }
    /* kÄ±rmÄ±zÄ± sÃ¼re Ã§ubuÄŸu (Ã¼stte, reklamÄ±n hemen altÄ±nda) */
    .progressWrap { height:8px; background:rgba(255,255,255,.08); }
    .progressBar { height:8px; width:0%; background:#ef4444; transition:width .25s linear; }

    video { width:100%; display:block; background:black; }
    .footer {
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .muted { color:#94a3b8; font-size:13px; }
    .btn {
      border:0; border-radius:12px; padding:10px 12px;
      font-weight:800; cursor:pointer;
      background:#e2e8f0; color:#0b1220;
    }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .ok { color:#a7f3d0; font-weight:700; }
    .err { color:#fecaca; font-weight:700; }
    .hint { margin-top:10px; font-size:13px; color:#94a3b8; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div class="title">ğŸ¬ Reklam</div>
        <div class="pill" id="pill">HazÄ±rlanÄ±yorâ€¦</div>
      </div>
      <div class="progressWrap"><div class="progressBar" id="bar"></div></div>

      <video  id=\"vid\" autoplay muted playsinline playsinline preload="auto"></video>

      <div class="footer">
        <div class="muted" id="status">Reklam hazÄ±rlanÄ±yorâ€¦</div>
        <button class="btn" id="closeBtn" disabled>Kapat</button>
      </div>
    </div>

    <div class="hint">
      Reklam otomatik baÅŸlar. SÃ¼re bitince Ã¶dÃ¼l eklenir ve sayfa otomatik kapanÄ±r.
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    const pill = document.getElementById('pill');
    const bar  = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const closeBtn = document.getElementById('closeBtn');
    const vid = document.getElementById('vid');

    let session_id = null;
    let durationSec = 0;
    let startedAt = 0;
    let ticker = null;

    function getTgId() {
      const id = tg?.initDataUnsafe?.user?.id;
      if (id) return Number(id);
      const p = new URLSearchParams(location.search);
      const uid = p.get('tg_id') || p.get('user_id');
      return uid ? Number(uid) : null;
    }

    async function postJSON(path, body) {
      const r = await fetch(path, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data?.reason || data?.error || ("HTTP " + r.status));
      return data;
    }

    function setProgress(pct) {
      const clamped = Math.max(0, Math.min(100, pct));
      bar.style.width = clamped.toFixed(2) + "%";
    }

    function setCountdown(rem) {
      pill.textContent = "SÃ¼re: " + rem + "s";
    }

    function stopTicker() {
      if (ticker) { clearInterval(ticker); ticker = null; }
    }

    async function completeAndClose() {
      try {
        statusEl.textContent = "Ã–dÃ¼l ekleniyorâ€¦";
        const tg_id = getTgId();
        await postJSON("/api/ad/complete", { tg_id, session_id });
        statusEl.innerHTML = '<span class="ok">âœ… Ã–dÃ¼l eklendi: +0.25 â‚º ve +0.25 ğŸ’</span>';
      } catch (e) {
        statusEl.innerHTML = '<span class="err">âŒ Ã–dÃ¼l yazÄ±lamadÄ±: ' + (e.message || e) + '</span>';
      } finally {
        closeBtn.disabled = false;
        setTimeout(() => {
          if (tg?.close) tg.close();
          else window.close();
        }, 1000);
      }
    }

    function startTimer(totalSec) {
      durationSec = Math.max(1, Math.floor(totalSec || 15));
      startedAt = Date.now();
      stopTicker();
      ticker = setInterval(() => {
        const elapsed = (Date.now() - startedAt) / 1000;
        const rem = Math.ceil(Math.max(0, durationSec - elapsed));
        const pct = (elapsed / durationSec) * 100;
        setProgress(pct);
        setCountdown(rem);
        if (rem <= 0) {
          stopTicker();
          completeAndClose();
        }
      }, 250);
    }

    async function startAdAuto() {
      const tg_id = getTgId();
      if (!tg_id) {
        statusEl.innerHTML = '<span class="err">âŒ Telegram iÃ§inde aÃ§malÄ±sÄ±n (tg_id alÄ±namadÄ±).</span>';
        pill.textContent = "Hata";
        closeBtn.disabled = false;
        return;
      }

      vid.muted = true;
      vid.controls = false;

      statusEl.textContent = "Reklam hazÄ±rlanÄ±yorâ€¦";
      pill.textContent = "YÃ¼kleniyorâ€¦";
      setProgress(0);

      const start = await postJSON("/api/ad/start", { tg_id });
      session_id = start.session_id;
      const ad = start.ad;

      const url = ad?.url;
      const sec = Number(ad?.seconds || 15);
      if (!url) throw new Error("Reklam bulunamadÄ±");

      vid.src = url;

      const playSafe = () => vid.play().catch(() => {});
      vid.addEventListener("loadedmetadata", () => {
        const vd = Number(vid.duration);
        if (Number.isFinite(vd) && vd > 0) startTimer(Math.ceil(vd));
        else startTimer(sec);
        playSafe();
      }, { once: true });

      vid.addEventListener("ended", () => {
        stopTicker();
        setProgress(100);
        setCountdown(0);
        completeAndClose();
      }, { once: true });

      playSafe();

      vid.addEventListener("click", () => {
        vid.muted = false;
        playSafe();
      });

      statusEl.textContent = "Reklam izleniyorâ€¦";
    }

    
    // ====== Sayfalar: Withdraw / Advertise ======
    async function renderWithdraw() {
      stopTicker();
      pill.textContent = "Para Ã‡ek";
      setProgress(0);
      vid.style.display = "none";
      const tg_id = getTgId();
      if (!tg_id) throw new Error("tg_id alÄ±namadÄ±");

      statusEl.innerHTML = `
        <div class="card" style="margin-top:12px">
          <div style="font-weight:700;margin-bottom:8px">ğŸ’¸ Para Ã‡ek</div>
          <div style="opacity:.9;font-size:13px;margin-bottom:10px">Minimum Ã§ekim tutarÄ± backend ayarÄ±na gÃ¶re kontrol edilir.</div>
          <label style="display:block;margin:6px 0 4px">Ad Soyad</label>
          <input id="w_name" style="width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e2e8f0" placeholder="Ad Soyad" />
          <label style="display:block;margin:10px 0 4px">IBAN</label>
          <input id="w_iban" style="width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e2e8f0" placeholder="TR00 0000 0000 0000 0000 0000 00" />
          <label style="display:block;margin:10px 0 4px">Tutar (TL)</label>
          <input id="w_amount" type="number" step="0.01" min="0" style="width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e2e8f0" placeholder="50" />
          <button id="w_send" style="margin-top:12px;width:100%;padding:12px;border-radius:12px;border:none;background:#22c55e;color:#052e16;font-weight:800;cursor:pointer">Talep OluÅŸtur</button>
          <div id="w_msg" style="margin-top:10px;font-size:13px"></div>
        </div>
      `;
      closeBtn.disabled = false;

      document.getElementById("w_send").onclick = async () => {
        const full_name = String(document.getElementById("w_name").value || "").trim();
        const iban = String(document.getElementById("w_iban").value || "").trim();
        const amount_tl = Number(document.getElementById("w_amount").value || 0);
        const msg = document.getElementById("w_msg");
        msg.textContent = "GÃ¶nderiliyorâ€¦";
        try {
          const r = await postJSON("/api/withdraw/request", { tg_id, full_name, iban, amount_tl });
          msg.innerHTML = '<span class="ok">âœ… Ã‡ekim talebin alÄ±ndÄ±.</span>';
        } catch(e) {
          msg.innerHTML = '<span class="err">âŒ ' + (e.message || e) + '</span>';
        }
      };
    }

    async function renderAdvertise() {
      stopTicker();
      pill.textContent = "Reklam Ver";
      setProgress(0);
      vid.style.display = "none";
      const tg_id = getTgId();
      if (!tg_id) throw new Error("tg_id alÄ±namadÄ±");

      statusEl.innerHTML = `
        <div class="card" style="margin-top:12px">
          <div style="font-weight:700;margin-bottom:8px">ğŸ“£ Reklam Ver</div>
          <div style="opacity:.9;font-size:13px;margin-bottom:10px">Reklam talebin admin onayÄ±ndan sonra yayÄ±na alÄ±nÄ±r.</div>
          <label style="display:block;margin:6px 0 4px">Ä°letiÅŸim (telefon/telegram)</label>
          <input id="a_contact" style="width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e2e8f0" placeholder="@kullaniciadi / 05xx" />
          <label style="display:block;margin:10px 0 4px">Reklam URL (mp4 / link)</label>
          <input id="a_url" style="width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e2e8f0" placeholder="https://..." />
          <label style="display:block;margin:10px 0 4px">SÃ¼re (sn)</label>
          <input id="a_sec" type="number" min="5" step="1" style="width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e2e8f0" placeholder="15" />
          <label style="display:block;margin:10px 0 4px">Hedef TÄ±klanma</label>
          <input id="a_clicks" type="number" min="10" step="1" style="width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e2e8f0" placeholder="1000" />
          <button id="a_send" style="margin-top:12px;width:100%;padding:12px;border-radius:12px;border:none;background:#60a5fa;color:#0b1220;font-weight:800;cursor:pointer">SipariÅŸ OluÅŸtur</button>
          <div id="a_msg" style="margin-top:10px;font-size:13px"></div>
        </div>
      `;
      closeBtn.disabled = false;

      document.getElementById("a_send").onclick = async () => {
        const contact = String(document.getElementById("a_contact").value || "").trim();
        const ad_url = String(document.getElementById("a_url").value || "").trim();
        const seconds = Number(document.getElementById("a_sec").value || 0);
        const target_clicks = Number(document.getElementById("a_clicks").value || 0);
        const msg = document.getElementById("a_msg");
        msg.textContent = "GÃ¶nderiliyorâ€¦";
        try {
          const r = await postJSON("/api/advertiser/submit", { tg_id, contact, ad_url, seconds, target_clicks });
          msg.innerHTML = '<span class="ok">âœ… Talep alÄ±ndÄ±. TÄ±klanma baÅŸÄ±: ' + r.price_per_click + ' â‚º, Toplam bÃ¼tÃ§e: ' + r.total_budget + ' â‚º</span>';
        } catch(e) {
          msg.innerHTML = '<span class="err">âŒ ' + (e.message || e) + '</span>';
        }
      };
    }

closeBtn.addEventListener("click", () => {
      if (tg?.close) tg.close();
      else window.close();
    });

    (async function boot(){
      try {
        const p = new URLSearchParams(location.search);
        const page = (p.get("page") || "").toLowerCase();
        const hasTg = !!getTgId();
        if (page === "withdraw") {
          await renderWithdraw();
        } else if (page === "advertise") {
          await renderAdvertise();
        } else {
          // default: watch (auto)
          if (hasTg) await startAdAuto();
          else {
            pill.textContent = "HazÄ±r";
            statusEl.textContent = "Bu sayfa Telegram WebApp iÃ§inde aÃ§Ä±lmalÄ±dÄ±r.";
            closeBtn.disabled = false;
          }
        }
      } catch (e) {
        stopTicker();
        pill.textContent = "Hata";
        statusEl.innerHTML = '<span class="err">âŒ ' + (e.message || e) + '</span>';
        closeBtn.disabled = false;
      }
    })();
  </script>
</body>
</html>
