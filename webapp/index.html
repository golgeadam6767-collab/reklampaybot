<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reklam Ä°zle</title>
  <style>
    :root{ color-scheme: dark; }
    body{ margin:0; background:#0b1220; color:#e7eefc; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; display:flex; justify-content:center; padding:18px;}
    .card{ width:min(520px,100%); background:linear-gradient(180deg,#0f1a33,#0b1220); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:16px; box-shadow:0 18px 50px rgba(0,0,0,.45);}
    .row{ display:flex; justify-content:space-between; align-items:center; gap:10px;}
    .title{ font-size:18px; font-weight:800;}
    .pill{ background:#f7b500; color:#1a1200; font-weight:800; padding:8px 12px; border-radius:999px; font-size:14px;}
    .frame{ margin-top:14px; height:260px; border-radius:14px; background:#000; overflow:hidden; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,.08);}
    iframe{ width:100%; height:100%; border:0;}
    .muted{ color:rgba(231,238,252,.75); font-size:13px; line-height:1.35; margin-top:10px;}
    button{ margin-top:14px; width:100%; padding:14px; border-radius:14px; border:0; font-size:16px; font-weight:800; cursor:pointer; background:#e6e9ef; color:#111827;}
  </style>
</head>
<body>
  <div class="card">
    <div class="row">
      <div class="title">ðŸ“º Reklam</div>
      <div class="pill" id="pill">HazÄ±rlanÄ±yor...</div>
    </div>
    <div class="frame" id="frame"><div id="placeholder">Reklam yÃ¼kleniyorâ€¦</div></div>
    <div class="muted" id="info">Bu sayfa otomatik reklam iÃ§in kullanÄ±lÄ±r. SÃ¼re bitince Ã¶dÃ¼l cÃ¼zdanÄ±na eklenir ve sayfa kapanÄ±r.</div>
    <button id="btnClose">Kapat</button>
  </div>

<script>
(()=> {
  const tg_id = new URLSearchParams(location.search).get("tg_id");
  const pill = document.getElementById("pill");
  const frame = document.getElementById("frame");
  const placeholder = document.getElementById("placeholder");
  const btnClose = document.getElementById("btnClose");

  function closeWebApp(){
    try{ if (window.Telegram && Telegram.WebApp) Telegram.WebApp.close(); }catch(e){}
    window.close();
  }
  btnClose.addEventListener("click", closeWebApp);

  if (!tg_id){
    pill.textContent="Hata";
    placeholder.textContent="tg_id yok. Bu sayfayÄ± bot Ã¼zerinden aÃ§malÄ±sÄ±n.";
    return;
  }

  let finished=false, nonce=null, required=0, timer=null;

  function renderAd(ad){
    frame.innerHTML="";
    if (ad.html){
      const d=document.createElement("div");
      d.style.width="100%"; d.style.height="100%";
      d.innerHTML = ad.html;
      frame.appendChild(d);
      return;
    }
    if (ad.youtube){
      const id = youtubeId(ad.youtube);
      const ifr=document.createElement("iframe");
      ifr.allow="autoplay; encrypted-media; picture-in-picture";
      ifr.allowFullscreen=true;
      ifr.src="https://www.youtube.com/embed/"+encodeURIComponent(id)+"?autoplay=1&mute=1&controls=0&rel=0";
      frame.appendChild(ifr);
      return;
    }
    if (ad.url){
      const ifr=document.createElement("iframe");
      ifr.src=ad.url;
      frame.appendChild(ifr);
      return;
    }
    frame.textContent="Reklam iÃ§eriÄŸi yok.";
  }

  function youtubeId(url){
    try{
      const u=new URL(url);
      if (u.hostname.includes("youtu.be")) return u.pathname.replace("/","");
      if (u.searchParams.get("v")) return u.searchParams.get("v");
      const m=u.pathname.match(/\/embed\/([^\/]+)/); if (m) return m[1];
    }catch(e){}
    return url;
  }

  async function jget(url){
    const r=await fetch(url);
    const j=await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(j.error || ("HTTP "+r.status));
    return j;
  }
  async function jpost(url, body){
    const r=await fetch(url,{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body)});
    const j=await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(j.error || ("HTTP "+r.status));
    return j;
  }

  async function start(){
    pill.textContent="YÃ¼kleniyor...";
    const next = await jget("/api/ad/next?tg_id="+encodeURIComponent(tg_id));
    if (next.none){
      pill.textContent="HazÄ±r";
      frame.innerHTML="";
      frame.textContent = next.message || "Åžu an reklam yok.";
      setTimeout(closeWebApp, 1200);
      return;
    }
    nonce = next.nonce;
    required = Number(next.ad.seconds || 10);
    if (!Number.isFinite(required) || required<=0) required=10;

    renderAd(next.ad);

    let remain = required;
    pill.textContent = remain + " sn";

    timer=setInterval(async ()=>{
      remain -= 1;
      if (remain < 0) remain = 0;
      pill.textContent = remain + " sn";
      if (remain===0 && !finished){
        finished=true;
        clearInterval(timer);
        pill.textContent="Bitti";
        await jpost("/api/ad/complete", { tg_id, nonce });
        setTimeout(closeWebApp, 600);
      }
    }, 1000);
  }

  start().catch(err=>{
    pill.textContent="Hata";
    frame.innerHTML="";
    frame.textContent = "Hata: " + (err.message || err);
  });
})();
</script>
</body>
</html>
