<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ReklaPay</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:#0f172a; color:#e2e8f0; }

    .top {
      padding: 14px 14px 110px 14px;
      max-width: 520px;
      margin: 0 auto;
    }
    .card {
      background: #111827;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
    }
    .row { display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .muted { color:#94a3b8; font-size: 13px; }
    .big { font-size: 18px; font-weight: 700; }

    .menuWrap {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(2,6,23,.92);
      border-top: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(8px);
    }
    .menu {
      max-width: 520px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .btn {
      border: 0;
      border-radius: 12px;
      padding: 12px 10px;
      font-weight: 700;
      color:#0b1220;
      background: #38bdf8;
      cursor:pointer;
    }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn.secondary { background:#22c55e; }
    .btn.dark { background:#e2e8f0; }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.85);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 9999;
    }
    .adBox {
      width: min(520px, 100%);
      background:#0b1220;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      overflow:hidden;
    }
    .adTop {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 12px;
      background:#111827;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-weight:700;
    }
    .pill { font-size: 13px; color:#0b1220; background:#fbbf24; padding:6px 10px; border-radius:999px; }
    video, img, iframe { width:100%; display:block; background:black; }
    .adBottom {
      padding: 12px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
    }
    .status { font-size: 13px; color:#94a3b8; }
    .toast { margin-top: 10px; font-size: 14px; color:#a7f3d0; display:none; }
    .err { color:#fecaca; }
  </style>
</head>
<body>
  <div class="top">
    <div class="card">
      <div class="row">
        <div>
          <div class="muted" id="who">Kullanƒ±cƒ±</div>
          <div class="big" id="vip">üëë VIP: ‚ùå Deƒüil</div>
        </div>
        <div style="text-align:right">
          <div class="muted">Bug√ºn</div>
          <div class="big" id="daily">0 / 50</div>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <div>
          <div class="muted">TL</div>
          <div class="big" id="tl">0.00 ‚Ç∫</div>
        </div>
        <div style="text-align:right">
          <div class="muted">Elmas</div>
          <div class="big" id="gem">0.00 üíé</div>
        </div>
      </div>
      <div class="toast" id="toast"></div>
    </div>
  </div>

  <div class="menuWrap">
    <div class="menu">
      <button class="btn" id="btnWatch">üëÄ Reklam izle</button>
      <button class="btn secondary" id="btnWallet">üíº C√ºzdan</button>
      <button class="btn dark" id="btnConvert">üîÅ D√∂n√º≈üt√ºr</button>
      <button class="btn dark" id="btnWithdraw">üí∏ Para √áek</button>
    </div>
  </div>

  <!-- Bottom sheet (clean, no links) -->
  <div class="overlay" id="sheet" style="align-items:flex-end;">
    <div class="adBox" style="border-bottom-left-radius:0;border-bottom-right-radius:0;">
      <div class="adTop">
        <div id="sheetTitle">C√ºzdan</div>
        <button class="btn" id="btnSheetClose" style="padding:8px 10px;border-radius:10px;">Kapat</button>
      </div>
      <div class="adBottom" style="display:block;">
        <div id="sheetBody"></div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="adBox">
      <div class="adTop">
        <div>Reklam</div>
        <div class="pill" id="timerPill">S√ºre: 0</div>
      </div>

      <div id="adBody"></div>

      <div class="adBottom">
        <div class="status" id="adStatus">ƒ∞zleniyor...</div>
        <button class="btn" id="btnClose" disabled>Kapat</button>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.expand(); }

    function getTgId() {
      const id = tg?.initDataUnsafe?.user?.id;
      return id ? Number(id) : null;
    }

    function toast(msg, isErr=false){
      const el = document.getElementById('toast');
      el.style.display = 'block';
      el.textContent = msg;
      el.className = 'toast' + (isErr ? ' err' : '');
      setTimeout(()=>{ el.style.display='none'; }, 4500);
    }

    const btnWatch = document.getElementById('btnWatch');
    const btnWallet = document.getElementById('btnWallet');
    const btnConvert = document.getElementById('btnConvert');
    const btnWithdraw = document.getElementById('btnWithdraw');
    const overlay = document.getElementById('overlay');
    const adBody = document.getElementById('adBody');
    const timerPill = document.getElementById('timerPill');
    const adStatus = document.getElementById('adStatus');
    const btnClose = document.getElementById('btnClose');

    const sheet = document.getElementById('sheet');
    const sheetTitle = document.getElementById('sheetTitle');
    const sheetBody = document.getElementById('sheetBody');
    const btnSheetClose = document.getElementById('btnSheetClose');

    let current = { session_id:null, tick:null, remaining:0, mode:'fixed' };
    let state = { settings: { gem_to_tl_rate: 0.25, min_withdraw_tl: 250, ref_bonus_rate: 0.10 } };

    async function api(path, body){
      const r = await fetch(path, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(data?.reason || data?.error || ('HTTP '+r.status));
      return data;
    }

    async function refreshMe(){
      const tg_id = getTgId();
      if (!tg_id) return;

      try {
        const r = await api('/api/me', { tg_id });
        if (!r.user) return;

        document.getElementById('tl').textContent = Number(r.user.balance).toFixed(2) + ' ‚Ç∫';
        document.getElementById('gem').textContent = Number(r.user.diamonds).toFixed(2) + ' üíé';
        document.getElementById('vip').textContent = 'üëë VIP: ' + (r.user.is_vip ? '‚úÖ Evet' : '‚ùå Deƒüil');
        document.getElementById('daily').textContent = `${r.daily.seen} / ${r.daily.limit}`;
        if (r.settings) state.settings = r.settings;
      } catch(e){ }
    }

    function openSheet(title, html){
      sheetTitle.textContent = title;
      sheetBody.innerHTML = html;
      sheet.style.display = 'flex';
    }
    function closeSheet(){
      sheet.style.display = 'none';
      sheetBody.innerHTML = '';
    }
    btnSheetClose.addEventListener('click', closeSheet);

    function openAd(ad){
      overlay.style.display = 'flex';
      adBody.innerHTML = '';

      if (ad.type === 'video') {
        const v = document.createElement('video');
        v.src = ad.url;
        v.autoplay = true;
        v.muted = false;
        v.playsInline = true;
        v.controls = false;
        v.preload = 'auto';
        adBody.appendChild(v);

        v.addEventListener('click', ()=> v.play().catch(()=>{}));
        setTimeout(()=> v.play().catch(()=>{}), 200);

        // variable duration countdown (never cut video)
        current.mode = 'video';
        v.addEventListener('loadedmetadata', ()=>{
          const d = Number(v.duration);
          if (Number.isFinite(d) && d > 0) startVideoCountdown(v);
          else startCountdown(ad.seconds || 15);
        });
        v.addEventListener('ended', async ()=>{
          await finishAd();
          closeOverlay();
        });

      } else if (ad.type === 'image') {
        const img = document.createElement('img');
        img.src = ad.url;
        adBody.appendChild(img);

      } else if (ad.type === 'html') {
        const iframe = document.createElement('iframe');
        iframe.src = ad.url;
        iframe.style.height = '60vh';
        iframe.setAttribute('sandbox','allow-scripts allow-same-origin allow-forms allow-popups');
        adBody.appendChild(iframe);
      }
    }

    function closeOverlay(){
      overlay.style.display = 'none';
      adBody.innerHTML = '';
      if (current.tick) { clearInterval(current.tick); current.tick = null; }
      current.session_id = null;
      current.remaining = 0;
    }

    function startCountdown(seconds){
      current.mode = 'fixed';
      current.remaining = seconds;
      timerPill.textContent = 'S√ºre: ' + current.remaining + 's';
      adStatus.textContent = 'Reklam izleniyor...';
      btnClose.disabled = true;

      current.tick = setInterval(async ()=>{
        current.remaining -= 1;
        if (current.remaining < 0) current.remaining = 0;
        timerPill.textContent = 'S√ºre: ' + current.remaining + 's';

        if (current.remaining === 0){
          clearInterval(current.tick);
          current.tick = null;
          await finishAd();      // √∂d√ºl√º yaz
          closeOverlay();        // ‚úÖ otomatik kapat
        }
      }, 1000);
    }

    function startVideoCountdown(videoEl){
      if (current.tick) { clearInterval(current.tick); current.tick = null; }
      btnClose.disabled = true;
      adStatus.textContent = 'Reklam izleniyor...';
      const update = ()=>{
        const dur = Number(videoEl.duration);
        const cur = Number(videoEl.currentTime);
        if (!Number.isFinite(dur) || dur <= 0) return;
        let rem = Math.ceil(Math.max(0, dur - cur));
        timerPill.textContent = 'S√ºre: ' + rem + 's';
      };
      update();
      current.tick = setInterval(update, 250);
    }

    async function finishAd(){
      try{
        adStatus.textContent = '√ñd√ºl i≈üleniyor...';
        const tg_id = getTgId();
        const done = await api('/api/ad/complete', { tg_id, session_id: current.session_id });

        toast(`‚úÖ √ñd√ºl eklendi: +${done.reward_tl}‚Ç∫ ve +${done.reward_gem}üíé`);
        await refreshMe(); // ‚úÖ √ºst paneli anƒ±nda g√ºncelle
      }catch(e){
        toast('‚ùå √ñd√ºl yazƒ±lamadƒ±: ' + e.message, true);
      }
    }

    btnClose.addEventListener('click', ()=> closeOverlay());

    btnWatch.addEventListener('click', async ()=>{
      try{
        const tg_id = getTgId();
        if (!tg_id){
          toast('Telegram i√ßinde a√ßmalƒ±sƒ±n (tg_id alƒ±namadƒ±).', true);
          return;
        }

        btnWatch.disabled = true;

        const start = await api('/api/ad/start', { tg_id });

        // g√ºnl√ºk sayƒ± anƒ±nda g√ºncelle
        document.getElementById('daily').textContent = `${start.seen} / ${start.limit}`;

        current.session_id = start.session_id;

        openAd(start.ad);
        // countdown handled after video metadata; fallback to seconds
        if (start.ad.type !== 'video') startCountdown(start.ad.seconds);

      }catch(e){
        toast('‚ùå Reklam ba≈ülatƒ±lamadƒ±: ' + e.message, true);
      }finally{
        btnWatch.disabled = false;
      }
    });

    document.getElementById('btnWallet').addEventListener('click', async ()=>{
      await refreshMe();
      openSheet('C√ºzdan', `
        <div class="row" style="margin-bottom:10px">
          <div><div class="muted">TL</div><div class="big">${document.getElementById('tl').textContent}</div></div>
          <div style="text-align:right"><div class="muted">Elmas</div><div class="big">${document.getElementById('gem').textContent}</div></div>
        </div>
        <div class="muted">D√∂n√º≈ü√ºm: 1 üíé = ${Number(state.settings.gem_to_tl_rate||0.25).toFixed(2)} ‚Ç∫</div>
        <div class="muted">Minimum √ßekim: ${Number(state.settings.min_withdraw_tl||250).toFixed(0)} ‚Ç∫</div>
      `);
    });

    document.getElementById('btnConvert').addEventListener('click', async ()=>{
      await refreshMe();
      const rate = Number(state.settings.gem_to_tl_rate||0.25);
      openSheet('Elmas ‚Üí TL D√∂n√º≈üt√ºr', `
        <div class="muted" style="margin-bottom:10px">Kur: 1 üíé = ${rate.toFixed(2)} ‚Ç∫</div>
        <div style="display:flex; gap:10px; align-items:center;">
          <input id="inpGems" type="number" min="1" step="1" placeholder="Elmas miktarƒ±" style="flex:1; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0b1220; color:#e2e8f0;" />
          <button class="btn" id="btnDoConvert">D√∂n√º≈üt√ºr</button>
        </div>
        <div class="muted" id="convHint" style="margin-top:10px"></div>
      `);
      const inp = document.getElementById('inpGems');
      const hint = document.getElementById('convHint');
      const btn = document.getElementById('btnDoConvert');
      inp.addEventListener('input', ()=>{
        const g = Math.floor(Number(inp.value||0));
        if (g>0) hint.textContent = `Tahmini: ${(g*rate).toFixed(2)} ‚Ç∫`; else hint.textContent='';
      });
      btn.addEventListener('click', async ()=>{
        try{
          const tg_id = getTgId();
          const g = Math.floor(Number(inp.value||0));
          if (!g) return toast('Elmas miktarƒ± gir.', true);
          btn.disabled = true;
          await api('/api/convert', { tg_id, gems: g });
          toast('‚úÖ D√∂n√º≈üt√ºr√ºld√º');
          await refreshMe();
          closeSheet();
        }catch(e){ toast('‚ùå ' + e.message, true); }
        finally{ btn.disabled=false; }
      });
    });

    document.getElementById('btnWithdraw').addEventListener('click', async ()=>{
      await refreshMe();
      const minW = Number(state.settings.min_withdraw_tl||250);
      openSheet('Para √áek', `
        <div class="muted" style="margin-bottom:10px">Minimum: ${minW.toFixed(0)} ‚Ç∫</div>
        <input id="inpName" placeholder="Ad Soyad" style="width:100%; margin-bottom:10px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0b1220; color:#e2e8f0;" />
        <input id="inpIban" placeholder="TR........................" style="width:100%; margin-bottom:10px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0b1220; color:#e2e8f0;" />
        <div style="display:flex; gap:10px; align-items:center;">
          <input id="inpAmount" type="number" min="${minW}" step="0.01" placeholder="Tutar (‚Ç∫)" style="flex:1; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0b1220; color:#e2e8f0;" />
          <button class="btn" id="btnDoWithdraw">G√∂nder</button>
        </div>
        <div class="muted" style="margin-top:10px">Not: Talep "pending" olarak d√º≈üer. Admin onaylayƒ±nca √∂denir.</div>
      `);
      const btn = document.getElementById('btnDoWithdraw');
      btn.addEventListener('click', async ()=>{
        try{
          const tg_id = getTgId();
          const full_name = String(document.getElementById('inpName').value||'').trim();
          const iban = String(document.getElementById('inpIban').value||'').trim();
          const amount_tl = Number(document.getElementById('inpAmount').value||0);
          if (!full_name) return toast('Ad Soyad yaz.', true);
          if (!iban) return toast('IBAN yaz.', true);
          if (!amount_tl) return toast('Tutar yaz.', true);
          btn.disabled = true;
          await api('/api/withdraw/request', { tg_id, full_name, iban, amount_tl });
          toast('‚úÖ √áekim talebi alƒ±ndƒ±');
          closeSheet();
        }catch(e){ toast('‚ùå ' + e.message, true); }
        finally{ btn.disabled=false; }
      });
    });

    (function initHeader(){
      const u = tg?.initDataUnsafe?.user;
      if (u){
        document.getElementById('who').textContent = '@' + (u.username || (u.first_name || 'user'));
      } else {
        document.getElementById('who').textContent = 'Kullanƒ±cƒ±';
      }
    })();

    // ‚úÖ sayfa a√ßƒ±lƒ±nca verileri √ßek
    refreshMe();

    // ‚úÖ action=watch/convert/withdraw/wallet auto
    (function autoAction(){
      const p = new URLSearchParams(location.search);
      const a = (p.get('action') || '').toLowerCase();
      if (a === 'watch') btnWatch.click();
      if (a === 'wallet') document.getElementById('btnWallet').click();
      if (a === 'convert') document.getElementById('btnConvert').click();
      if (a === 'withdraw') document.getElementById('btnWithdraw').click();
    })();
  </script>
</body>
</html>
