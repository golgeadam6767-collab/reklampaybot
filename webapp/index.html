<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ReklaPay</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    (function(){
      try{
        const p = new URLSearchParams(location.search);
        if ((p.get('action')||'').toLowerCase()==='watch'){
          document.documentElement.style.visibility = 'hidden';
          document.documentElement.style.background = '#000';
        }
      }catch(e){}
    })();
  </script>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:#0f172a; color:#e2e8f0; }

    .top {
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom)) 14px;
      max-width: 520px;
      margin: 0 auto;
    }
    .card {
      background: #111827;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
    }
    .row { display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .muted { color:#94a3b8; font-size: 13px; }
    .big { font-size: 18px; font-weight: 700; }

    .toast { margin-top: 10px; font-size: 14px; color:#a7f3d0; display:none; }
    .err { color:#fecaca; }

    /* Bottom sheet (page iÃ§i) */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.85);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 9999;
    }
    .sheetWrap { align-items:flex-end; }
    .box {
      width: min(520px, 100%);
      background:#0b1220;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      overflow:hidden;
    }
    .topbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 12px;
      background:#111827;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-weight:700;
    }
    .pill { font-size: 13px; color:#0b1220; background:#fbbf24; padding:6px 10px; border-radius:999px; }
    .body { padding: 12px; }
    .btn {
      border: 0;
      border-radius: 12px;
      padding: 12px 10px;
      font-weight: 800;
      color:#0b1220;
      background: #e2e8f0;
      cursor:pointer;
    }
    .btn.primary { background:#38bdf8; }
    .btn.green { background:#22c55e; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .input {
      width:100%;
      margin-bottom:10px;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:#0b1220;
      color:#e2e8f0;
      box-sizing:border-box;
    }

    /* Reklam overlay */
    .progressWrap{
      height: 8px;
      background: rgba(255,255,255,.10);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .progressBar{
      height: 100%;
      width: 0%;
      background: #ef4444; /* kÄ±rmÄ±zÄ± */
      transition: width 120ms linear;
    }
    video, img, iframe { width:100%; display:block; background:black; }
    .adBottom {
      padding: 12px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
    }
    .status { font-size: 13px; color:#94a3b8; }
  </style>
</head>
<body>
  <div class="top">
    <div class="card">
      <div class="row">
        <div>
          <div class="muted" id="who">KullanÄ±cÄ±</div>
          <div class="big" id="vip">ğŸ‘‘ VIP: âŒ DeÄŸil</div>
        </div>
        <div style="text-align:right">
          <div class="muted">BugÃ¼n</div>
          <div class="big" id="daily">0 / 50</div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <div>
          <div class="muted">TL</div>
          <div class="big" id="tl">0.00 â‚º</div>
        </div>
        <div style="text-align:right">
          <div class="muted">Elmas</div>
          <div class="big" id="gem">0.00 ğŸ’</div>
        </div>
      </div>

      <div class="toast" id="toast"></div>
      <div class="muted" style="margin-top:10px">
        
      </div>
    </div>
  </div>

  <!-- Sheet -->
  <div class="overlay sheetWrap" id="sheet">
    <div class="box" style="border-bottom-left-radius:0;border-bottom-right-radius:0;">
      <div class="topbar">
        <div id="sheetTitle">Bilgi</div>
        <button class="btn" id="btnSheetClose" style="padding:8px 10px;border-radius:10px;">Kapat</button>
      </div>
      <div class="body" id="sheetBody"></div>
    </div>
  </div>

  <!-- Reklam Overlay -->
  <div class="overlay" id="overlay">
    <div class="box">
      <div class="topbar">
        <div>Reklam</div>
        <div class="pill" id="timerPill">SÃ¼re: 0</div>
      </div>

      <div class="progressWrap">
        <div class="progressBar" id="progressBar"></div>
      </div>

      <div id="adBody"></div>

      <div class="adBottom">
        <div class="status" id="adStatus">Ä°zleniyor...</div>
        <button class="btn" id="btnClose" disabled>Kapat</button>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    const ADMIN_ID = 7784281785;

    function getTgId() {
      const id = tg?.initDataUnsafe?.user?.id;
      if (id) return Number(id);
      try{
        const qs = new URLSearchParams(location.search);
        const uid = qs.get('tg_id') || qs.get('user_id');
        if (uid) return Number(uid);
      }catch(e){}
      return null;
    }

    function toast(msg, isErr=false){
      const el = document.getElementById('toast');
      el.style.display = 'block';
      el.textContent = msg;
      el.className = 'toast' + (isErr ? ' err' : '');
      setTimeout(()=>{ el.style.display='none'; }, 4500);
    }

    async function api(path, body){
      const r = await fetch(path, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(data?.reason || data?.error || ('HTTP '+r.status));
      return data;
    }

    async function refreshMe(){
      const tg_id = getTgId();
      if (!tg_id) return;
      try {
        const r = await api('/api/me', { tg_id });
        if (!r.user) return;

        const bal = (r.user.balance ?? r.user.balance_tl ?? r.user.tl ?? 0);
        const dia = (r.user.diamonds ?? r.user.gems ?? r.user.elmas ?? 0);

        document.getElementById('tl').textContent = Number(bal).toFixed(2) + ' â‚º';
        document.getElementById('gem').textContent = Number(dia).toFixed(2) + ' ğŸ’';
        document.getElementById('vip').textContent = 'ğŸ‘‘ VIP: ' + (r.user.is_vip ? 'âœ… Evet' : 'âŒ DeÄŸil');
        if (r.daily) document.getElementById('daily').textContent = `${r.daily.seen} / ${r.daily.limit}`;
        window.__settings = r.settings || window.__settings || { gem_to_tl_rate: 0.25, min_withdraw_tl: 250, ref_bonus_rate: 0.10 };
      } catch(e){ /* sessiz */ }
    }

    // Sheets
    const sheet = document.getElementById('sheet');
    const sheetTitle = document.getElementById('sheetTitle');
    const sheetBody = document.getElementById('sheetBody');
    document.getElementById('btnSheetClose').addEventListener('click', ()=> {
      sheet.style.display = 'none';
      sheetBody.innerHTML = '';
    });

    function openSheet(title, html){
      sheetTitle.textContent = title;
      sheetBody.innerHTML = html;
      sheet.style.display = 'flex';
    }

    function openWallet(){
      openSheet('ğŸ’¼ CÃ¼zdan', `
        <div class="row" style="margin-bottom:10px">
          <div><div class="muted">TL</div><div class="big">${document.getElementById('tl').textContent}</div></div>
          <div style="text-align:right"><div class="muted">Elmas</div><div class="big">${document.getElementById('gem').textContent}</div></div>
        </div>
        <div class="muted">DÃ¶nÃ¼ÅŸÃ¼m: 1 ğŸ’ = ${(Number(window.__settings?.gem_to_tl_rate||0.25)).toFixed(2)} â‚º</div>
        <div class="muted">Minimum Ã§ekim: ${(Number(window.__settings?.min_withdraw_tl||250)).toFixed(0)} â‚º</div>
      `);
    }

    function openConvert(){
      const rate = Number(window.__settings?.gem_to_tl_rate || 0.25);
      openSheet('ğŸ’ Elmas â†’ TL DÃ¶nÃ¼ÅŸtÃ¼r', `
        <div class="muted" style="margin-bottom:10px">Kur: 1 ğŸ’ = ${rate.toFixed(2)} â‚º</div>
        <div style="display:flex; gap:10px; align-items:center;">
          <input id="inpGems" class="input" style="flex:1;margin:0" type="number" min="1" step="1" placeholder="Elmas miktarÄ±" />
          <button class="btn primary" id="btnDoConvert">DÃ¶nÃ¼ÅŸtÃ¼r</button>
        </div>
        <div class="muted" id="convHint" style="margin-top:10px"></div>
      `);

      const inp = document.getElementById('inpGems');
      const hint = document.getElementById('convHint');
      const btn = document.getElementById('btnDoConvert');

      inp.addEventListener('input', ()=>{
        const g = Math.floor(Number(inp.value||0));
        hint.textContent = g>0 ? `Tahmini: ${(g*rate).toFixed(2)} â‚º` : '';
      });

      btn.addEventListener('click', async ()=>{
        try{
          const tg_id = getTgId();
          const g = Math.floor(Number(inp.value||0));
          if (!g) return toast('Elmas miktarÄ± gir.', true);
          btn.disabled = true;
          await api('/api/convert', { tg_id, gems: g });
          toast('âœ… DÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼');
          await refreshMe();
        try{ if (tg) setTimeout(()=>tg.close(), 650); }catch(_){ }
          sheet.style.display = 'none';
        }catch(e){ toast('âŒ ' + e.message, true); }
        finally{ btn.disabled=false; }
      });
    }

    function openWithdraw(){
      const minW = Number(window.__settings?.min_withdraw_tl || 250);
      openSheet('ğŸ’¸ Para Ã‡ek', `
        <div class="muted" style="margin-bottom:10px">Minimum: ${minW.toFixed(0)} â‚º</div>
        <input id="inpName" class="input" placeholder="Ad Soyad" />
        <input id="inpIban" class="input" placeholder="TR........................" />
        <div style="display:flex; gap:10px; align-items:center;">
          <input id="inpAmount" class="input" style="flex:1;margin:0" type="number" min="${minW}" step="0.01" placeholder="Tutar (â‚º)" />
          <button class="btn primary" id="btnDoWithdraw">GÃ¶nder</button>
        </div>
        <div class="muted" style="margin-top:10px">Not: Talep 'pending' olarak dÃ¼ÅŸer. Admin onaylayÄ±nca Ã¶denir.</div>
      `);

      const btn = document.getElementById('btnDoWithdraw');
      btn.addEventListener('click', async ()=>{
        try{
          const tg_id = getTgId();
          const full_name = String(document.getElementById('inpName').value||'').trim();
          const iban = String(document.getElementById('inpIban').value||'').trim();
          const amount_tl = Number(document.getElementById('inpAmount').value||0);

          if (!full_name) return toast('Ad Soyad yaz.', true);
          if (!iban) return toast('IBAN yaz.', true);
          if (!amount_tl) return toast('Tutar yaz.', true);

          btn.disabled = true;
          await api('/api/withdraw/request', { tg_id, full_name, iban, amount_tl });
          toast('âœ… Ã‡ekim talebi alÄ±ndÄ±');
          sheet.style.display = 'none';
        }catch(e){ toast('âŒ ' + e.message, true); }
        finally{ btn.disabled=false; }
      });
    }

    function openVIP(){
      openSheet('ğŸ‘‘ VIP', `
        <div class="big" style="margin-bottom:6px">VIP Reklamlar</div>
        <div class="muted">VIP reklamlar elmas token karÅŸÄ±lÄ±ÄŸÄ± izlenir ve daha fazla kazandÄ±rÄ±r.</div>
        <div class="muted" style="margin-top:10px">Bu bÃ¶lÃ¼mÃ¼n iÅŸlevi sonra baÄŸlanacak.</div>
        <div style="height:12px"></div>
        <button class="btn green" onclick="toast('YakÄ±nda âœ…');">YakÄ±nda</button>
      `);
    }

    function openRef(){
      const tg_id = getTgId();
      const qs = new URLSearchParams(location.search);
      const botUser = qs.get('bot') || 'BOT_USERNAME'; // bot otomatik gelmezse fallback
      const link = tg_id ? `https://t.me/${botUser}?start=ref_${tg_id}` : 'Telegram iÃ§inde aÃ§malÄ±sÄ±n';
      openSheet('ğŸ Referans', `
        <div class="muted" style="margin-bottom:10px">Davet linkin:</div>
        <input class="input" id="refLink" value="${link}" readonly />
        <button class="btn primary" id="btnCopyRef">Kopyala</button>
        <div class="muted" style="margin-top:10px">Referans kazancÄ±: %${Math.round((Number(window.__settings?.ref_bonus_rate||0.10))*100)}</div>
      `);

      document.getElementById('btnCopyRef').addEventListener('click', async ()=>{
        try{
          const v = document.getElementById('refLink').value;
          await navigator.clipboard.writeText(v);
          toast('âœ… KopyalandÄ±');
        }catch(e){
          toast('KopyalanamadÄ±', true);
        }
      });
    }

    function openInfo(){
      openSheet('â„¹ï¸ Bilgi', `
        <div class="big" style="margin-bottom:6px">Sistem NasÄ±l Ã‡alÄ±ÅŸÄ±r?</div>
        <div class="muted">â€¢ Reklam izleyerek TL ve Elmas kazanÄ±rsÄ±n.</div>
        <div class="muted">â€¢ ElmaslarÄ±nÄ± TL'ye Ã§evirebilirsin.</div>
        <div class="muted">â€¢ Para Ã§ekme minimumu: ${(Number(window.__settings?.min_withdraw_tl||250)).toFixed(0)} â‚º</div>
        <div class="muted">â€¢ Referans: Davet ettiklerinin kazancÄ±ndan %${Math.round((Number(window.__settings?.ref_bonus_rate||0.10))*100)} alÄ±rsÄ±n.</div>
      `);
    }

    function openAdvertise(){
      // Reklam veren paneli (ÅŸimdilik sadece UI)
      const pricing = {
        short: { label: '10 - 30 saniye', unit: 1.75, desc: 'TÄ±klanma baÅŸÄ±: 1.75 â‚º' },
        long:  { label: '30 - 240 saniye', unit: 2.25, desc: 'TÄ±klanma baÅŸÄ±: 2.25 â‚º' },
      };

      openSheet('ğŸ“£ Reklam Ver', `
        <div class="muted" style="margin-bottom:10px">ReklamÄ±n saniyesine gÃ¶re birim fiyat otomatik seÃ§ilir.</div>

        <div class="row" style="gap:10px; align-items:flex-start; margin-bottom:10px">
          <div style="flex:1">
            <div class="muted">Reklam TÃ¼rÃ¼</div>
            <select id="adTier" style="width:100%; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0b1220; color:#e2e8f0;">
              <option value="short">${pricing.short.label} (${pricing.short.unit.toFixed(2)} â‚º/tÄ±klanma)</option>
              <option value="long">${pricing.long.label} (${pricing.long.unit.toFixed(2)} â‚º/tÄ±klanma)</option>
            </select>
          </div>
          <div style="flex:1">
            <div class="muted">Reklam SÃ¼resi (sn)</div>
            <input id="adSeconds" type="number" min="10" max="240" value="15" style="width:100%; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0b1220; color:#e2e8f0;" />
          </div>
        </div>

        <div class="row" style="gap:10px; align-items:flex-start; margin-bottom:10px">
          <div style="flex:1">
            <div class="muted">Hedef TÄ±klanma (adet)</div>
            <input id="adClicks" type="number" min="50" step="1" value="500" style="width:100%; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0b1220; color:#e2e8f0;" />
          </div>
          <div style="flex:1">
            <div class="muted">Reklam Linki (video/gif/url)</div>
            <input id="adUrl" placeholder="https://..." style="width:100%; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0b1220; color:#e2e8f0;" />
          </div>
        </div>

        <div class="muted" id="adPriceLine" style="margin-top:6px"></div>
        <div class="muted" id="adTotalLine" style="margin-top:6px"></div>

        <div style="height:10px"></div>
        <button class="btn" id="btnAdSubmit">Teklif OluÅŸtur (Onaya GÃ¶nder)</button>

        <div class="muted" style="margin-top:10px">Not: Reklamlar admin onayÄ±ndan sonra yayÄ±na alÄ±nÄ±r. (Åimdilik backend endpoint yoksa sadece hesaplama yapar.)</div>
      `);

      const tierEl = document.getElementById('adTier');
      const secEl  = document.getElementById('adSeconds');
      const clkEl  = document.getElementById('adClicks');
      const priceLine = document.getElementById('adPriceLine');
      const totalLine = document.getElementById('adTotalLine');
      const btn = document.getElementById('btnAdSubmit');

      function inferTierBySeconds(){
        const s = Number(secEl.value||0);
        if (s >= 30) tierEl.value = 'long';
        else tierEl.value = 'short';
      }

      function recalc(){
        const tier = pricing[tierEl.value] || pricing.short;
        const clicks = Math.max(0, Math.floor(Number(clkEl.value||0)));
        priceLine.textContent = `Birim fiyat: ${tier.unit.toFixed(2)} â‚º/tÄ±klanma  (${tier.label})`;
        totalLine.textContent = `Toplam bÃ¼tÃ§e: ${(clicks * tier.unit).toFixed(2)} â‚º  (Hedef tÄ±klanma: ${clicks})`;
      }

      secEl.addEventListener('input', ()=>{ inferTierBySeconds(); recalc(); });
      tierEl.addEventListener('change', recalc);
      clkEl.addEventListener('input', recalc);

      inferTierBySeconds();
      recalc();

      btn.addEventListener('click', async ()=>{
        try{
          const tg_id = getTgId();
          if (!tg_id) return toast('Telegram iÃ§inde aÃ§malÄ±sÄ±n (tg_id alÄ±namadÄ±).', true);

          const seconds = Math.floor(Number(secEl.value||0));
          const clicks = Math.floor(Number(clkEl.value||0));
          const url = String(document.getElementById('adUrl').value||'').trim();
          if (!seconds || seconds < 10 || seconds > 240) return toast('SÃ¼re 10-240 sn olmalÄ±.', true);
          if (!clicks || clicks < 1) return toast('Hedef tÄ±klanma gir.', true);
          if (!url) return toast('Reklam linki gir.', true);

          const tier = (seconds >= 30) ? pricing.long : pricing.short;
          const total = clicks * tier.unit;

          // Backend hazÄ±r olunca burayÄ± aÃ§arÄ±z:
          // await api('/api/advertise/request', { tg_id, seconds, clicks_target: clicks, unit_price: tier.unit, total_budget: total, url });

          toast(`âœ… Teklif hazÄ±r: ${tier.unit.toFixed(2)} â‚º/tÄ±k â€¢ ${clicks} tÄ±k â€¢ Toplam ${total.toFixed(2)} â‚º (Admin onayÄ± bekler)`);
          // closeSheet();
        }catch(e){
          toast('âŒ ' + e.message, true);
        }
      });
    }

    function openForum(){
      const tg_id = getTgId();
      const isAdmin = Number(tg_id) === ADMIN_ID;

      if (isAdmin){
        openSheet('ğŸ’¬ Forum (Admin)', `
          <div class="big" style="margin-bottom:6px">Forum BaÅŸlÄ±klarÄ±</div>
          <div class="muted">Åimdilik taslak. YakÄ±nda: baÅŸlÄ±k aÃ§ma, konu onayÄ±, yorumlar.</div>
          <div style="height:10px"></div>
          <div class="card" style="margin-bottom:10px">
            <div class="big" style="font-size:16px">â• Yeni BaÅŸlÄ±k AÃ§</div>
            <div style="height:8px"></div>
            <input id="forumTitle" class="input" placeholder="BaÅŸlÄ±k adÄ± (Ã¶rn: GÃ¼ncel KazanÃ§lar)" />
            <button class="btn primary" id="btnForumCreate">BaÅŸlÄ±ÄŸÄ± Ekle</button>
            <div class="muted" style="margin-top:8px">Not: Bu buton ÅŸimdilik sadece arayÃ¼z (yakÄ±nda DB).</div>
          </div>

          <div class="big" style="font-size:16px; margin-bottom:8px">Ã–rnek BaÅŸlÄ±klar</div>
          <div class="muted">â€¢ Genel Sohbet</div>
          <div class="muted">â€¢ KazanÃ§ Taktikleri</div>
          <div class="muted">â€¢ Ã–deme / Ã‡ekim SorunlarÄ±</div>
        `);

        document.getElementById('btnForumCreate').addEventListener('click', ()=>{
          toast('âœ… BaÅŸlÄ±k eklendi (yakÄ±nda DB)', false);
        });
        return;
      }

      openSheet('ğŸ’¬ Forum', `
        <div class="big" style="margin-bottom:6px">Forum</div>
        <div class="muted">Buradan Ã¼yeler konu paylaÅŸabilecek ve sohbet edebilecek.</div>
        <div class="muted" style="margin-top:10px">Åimdilik taslak. BaÅŸlÄ±klarÄ± admin aÃ§acak.</div>
        <div style="height:12px"></div>

        <div class="big" style="font-size:16px; margin-bottom:8px">Mevcut BaÅŸlÄ±klar (Ã¶rnek)</div>
        <div class="muted">â€¢ Genel Sohbet</div>
        <div class="muted">â€¢ KazanÃ§ Taktikleri</div>
        <div class="muted">â€¢ Ã–deme / Ã‡ekim SorunlarÄ±</div>

        <div style="height:12px"></div>
        <button class="btn primary" onclick="toast('YakÄ±nda: konu aÃ§ma âœ…');">Konu PaylaÅŸ (YakÄ±nda)</button>
      `);
    }

    function openAdmin(){
      const tg_id = getTgId();
      if (Number(tg_id) !== ADMIN_ID){
        openSheet('ğŸ›  Admin', `<div class="muted">Yetkin yok.</div>`);
        return;
      }
      openSheet('ğŸ›  Admin', `
        <div class="big" style="margin-bottom:6px">Admin Panel (Taslak)</div>
        <div class="muted">Bu ekrandaki iÅŸlemler sonraki adÄ±mda baÄŸlanacak.</div>
        <div style="height:12px"></div>

        <div class="card" style="margin-bottom:10px">
          <div class="big" style="font-size:16px">âœ… Reklam Ekle</div>
          <div class="muted">YouTube / Video / GIF linki + sÃ¼re + Ã¶dÃ¼l</div>
          <div style="height:8px"></div>
          <button class="btn primary" onclick="toast('YakÄ±nda âœ…');">AÃ§</button>
        </div>

        <div class="card" style="margin-bottom:10px">
          <div class="big" style="font-size:16px">ğŸ’¸ Para Ã‡ekim OnayÄ±</div>
          <div class="muted">Talepleri listele, onayla / reddet</div>
          <div style="height:8px"></div>
          <button class="btn primary" onclick="toast('YakÄ±nda âœ…');">AÃ§</button>
        </div>

        <div class="card">
          <div class="big" style="font-size:16px">âš™ï¸ Ayarlar</div>
          <div class="muted">Kur, min Ã§ekim, referans oranÄ±</div>
          <div style="height:8px"></div>
          <button class="btn primary" onclick="toast('YakÄ±nda âœ…');">AÃ§</button>
        </div>
      `);
    }

    // Reklam overlay logic
    const overlay = document.getElementById('overlay');
    const adBody = document.getElementById('adBody');
    const timerPill = document.getElementById('timerPill');
    const adStatus = document.getElementById('adStatus');
    const btnClose = document.getElementById('btnClose');
    const progressBar = document.getElementById('progressBar');

    let current = { session_id:null, tick:null, total:0, remaining:0, finished:false };

    function setProgress(pct){
      const p = Math.max(0, Math.min(100, pct));
      progressBar.style.width = p.toFixed(2) + '%';
    }

    function closeOverlay(){
      overlay.style.display = 'none';
      adBody.innerHTML = '';
      if (current.tick) { clearInterval(current.tick); current.tick = null; }
      current.session_id = null;
      current.finished = false;
      current.total = 0;
      current.remaining = 0;
      setProgress(0);
    }

    btnClose.addEventListener('click', closeOverlay);

    function openAd(ad){
      overlay.style.display = 'flex';
      adBody.innerHTML = '';
      setProgress(0);
      btnClose.disabled = true;
      adStatus.textContent = 'Reklam izleniyor...';

      if (ad.type === 'video') {
        const v = document.createElement('video');
        v.src = ad.url;
        v.autoplay = true;
        v.muted = false;
        v.playsInline = true;
        v.controls = false;
        v.preload = 'auto';
        adBody.appendChild(v);

        v.addEventListener('click', ()=> v.play().catch(()=>{}));
        setTimeout(()=> v.play().catch(()=>{}), 200);

        v.addEventListener('error', ()=>{ startCountdown(ad.seconds || 15); });

        v.addEventListener('loadedmetadata', ()=>{
          const d = Number(v.duration);
          if (Number.isFinite(d) && d > 0) startVideoCountdown(v);
          else startCountdown(ad.seconds || 15);
        });

        v.addEventListener('ended', async ()=>{
          await finishAd();
          closeOverlay();
        });

      } else if (ad.type === 'image') {
        const img = document.createElement('img');
        img.src = ad.url;
        adBody.appendChild(img);
        startCountdown(ad.seconds || 15);

      } else if (ad.type === 'html') {
        const iframe = document.createElement('iframe');
        iframe.src = ad.url;
        iframe.style.height = '60vh';
        iframe.setAttribute('sandbox','allow-scripts allow-same-origin allow-forms allow-popups');
        adBody.appendChild(iframe);
        startCountdown(ad.seconds || 15);
      }
    }

    function startCountdown(seconds){
      if (current.tick) { clearInterval(current.tick); current.tick = null; }
      current.total = Number(seconds) || 15;
      current.remaining = current.total;

      timerPill.textContent = 'SÃ¼re: ' + current.remaining + 's';
        if (progressBar){
          const done = (current.total - current.remaining) / current.total;
          progressBar.style.width = Math.min(100, Math.max(0, done*100)).toFixed(1) + '%';
        }
      setProgress(0);

      current.tick = setInterval(async ()=>{
        current.remaining -= 1;
        if (current.remaining < 0) current.remaining = 0;
        timerPill.textContent = 'SÃ¼re: ' + current.remaining + 's';
        if (progressBar){
          const done = (current.total - current.remaining) / current.total;
          progressBar.style.width = Math.min(100, Math.max(0, done*100)).toFixed(1) + '%';
        }

        const watched = current.total - current.remaining;
        setProgress(current.total > 0 ? (watched / current.total) * 100 : 0);

        if (current.remaining === 0){
          if (progressBar) progressBar.style.width = '100%';
          clearInterval(current.tick);
          current.tick = null;
          setProgress(100);
          await finishAd();
          closeOverlay();
        }
      }, 1000);
    }

    function startVideoCountdown(videoEl){
      if (current.tick) { clearInterval(current.tick); current.tick = null; }

      const update = ()=>{
        const dur = Number(videoEl.duration);
        const cur = Number(videoEl.currentTime);
        if (!Number.isFinite(dur) || dur <= 0) return;

        const rem = Math.ceil(Math.max(0, dur - cur));
        timerPill.textContent = 'SÃ¼re: ' + rem + 's';
        if (progressBar){
          const done = dur>0 ? (cur/dur) : 0;
          progressBar.style.width = Math.min(100, Math.max(0, done*100)).toFixed(1) + '%';
        }
        setProgress(Math.max(0, Math.min(100, (cur / dur) * 100)));
      };

      update();
      current.tick = setInterval(update, 250);
    }

    async function finishAd(){
      if (current.finished) return;
      if (!current.session_id) { toast('âŒ session_id yok (reklam oturumu bulunamadÄ±).', true); return; }
      current.finished = true;
      try{
        adStatus.textContent = 'Ã–dÃ¼l iÅŸleniyor...';
        const tg_id = getTgId();
        const done = await api('/api/ad/complete', { tg_id, session_id: current.session_id });

        // UI anÄ±nda gÃ¼ncelle (optimistic)
        const curTl = Number(String(document.getElementById('tl').textContent).replace(/[^0-9.]/g,'')) || 0;
        const curGem = Number(String(document.getElementById('gem').textContent).replace(/[^0-9.]/g,'')) || 0;
        const addTl = Number(done.reward_tl ?? 0.25);
        const addGem = Number(done.reward_gem ?? 0.25);
        document.getElementById('tl').textContent = (curTl + addTl).toFixed(2) + ' â‚º';
        document.getElementById('gem').textContent = (curGem + addGem).toFixed(2) + ' ğŸ’';

        toast(`âœ… Ã–dÃ¼l eklendi: +${addTl.toFixed(2)}â‚º ve +${addGem.toFixed(2)}ğŸ’`);
        await refreshMe();
        try{ if (tg) setTimeout(()=>tg.close(), 650); }catch(_){ }
      }catch(e){
        toast('âŒ Ã–dÃ¼l yazÄ±lamadÄ±: ' + e.message, true);
      }
    }

    async function startAdFlow(){
      document.documentElement.style.visibility = 'visible';
      const tg_id = getTgId();
      if (!tg_id){
        toast('Telegram iÃ§inde aÃ§malÄ±sÄ±n (tg_id alÄ±namadÄ±).', true);
        return;
      }

      try{
        const start = await api('/api/ad/start', { tg_id });
        if (start?.seen != null && start?.limit != null){
          document.getElementById('daily').textContent = `${start.seen} / ${start.limit}`;
        }
        current.session_id = start.session_id;
        current.finished = false;
        openAd(start.ad);
        // video dÄ±ÅŸÄ± akÄ±ÅŸta sayaÃ§ startCountdown iÃ§inde zaten baÅŸlar
      }catch(e){
        toast('âŒ Reklam baÅŸlatÄ±lamadÄ±: ' + e.message, true);
      }
    }

    // Header username
    (function initHeader(){
      const u = tg?.initDataUnsafe?.user;
      if (u){
        document.getElementById('who').textContent = '@' + (u.username || (u.first_name || 'user'));
      } else {
        document.getElementById('who').textContent = 'KullanÄ±cÄ±';
      }
    })();

    // AÃ§Ä±lÄ±ÅŸta veri
    refreshMe();

    // action router (menÃ¼ botta)
    (async function autoAction(){
      const p = new URLSearchParams(location.search);
      const a = (p.get('action') || '').toLowerCase();

      if (!a) return;

      // Ã¶nce kullanÄ±cÄ± bilgisi gelsin
      await refreshMe();
        try{ if (tg) setTimeout(()=>tg.close(), 650); }catch(_){ }

      if (a === 'watch') { setTimeout(()=>{ startAdFlow(); }, 150); return; }
      if (a === 'wallet') return openWallet();
      if (a === 'convert') return openConvert();
      if (a === 'withdraw') return openWithdraw();
      if (a === 'vip') return openVIP();
      if (a === 'ref') return openRef();
      if (a === 'info') return openInfo();
      if (a === 'advertise') return openAdvertise();
      if (a === 'forum') return openForum();
      if (a === 'admin') return openAdmin();
    })();
  </script>
</body>
</html>
