<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Reklam</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{margin:0;background:#0b1220;color:#e6eefc;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:520px;margin:0 auto;padding:14px}
    .card{background:#0f1b33;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .badge{background:#fbbf24;color:#111827;padding:6px 10px;border-radius:999px;font-weight:700}
    .adbox{margin-top:12px;height:220px;background:#000;border-radius:14px;display:flex;align-items:center;justify-content:center;color:#9aa7c2}
    .btn{margin-top:12px;width:100%;padding:12px 14px;border-radius:14px;border:0;font-weight:700}
    .btnClose{background:#e5e7eb;color:#111827}
    .muted{color:#9aa7c2;font-size:13px;line-height:1.4;margin-top:10px}
    .ok{color:#34d399}
    .err{color:#fb7185}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div style="font-weight:800;font-size:18px">ğŸ¬ Reklam</div>
        <div id="status" class="badge">HazÄ±r</div>
      </div>

      <div class="adbox" id="adbox">Reklam otomatik baÅŸlayacakâ€¦</div>

      <div class="muted" id="info">
        Bu sayfa otomatik reklam iÃ§in kullanÄ±lÄ±r.<br/>
        SÃ¼re bitince Ã¶dÃ¼l cÃ¼zdanÄ±na eklenir ve sayfa kapanÄ±r.
      </div>

      <button class="btn btnClose" id="btnClose">Kapat</button>
    </div>
  </div>

<script>
(function(){
  const tg = window.Telegram?.WebApp;
  try { tg?.expand(); } catch(e){}

  const statusEl = document.getElementById('status');
  const adbox = document.getElementById('adbox');
  const info = document.getElementById('info');
  const btnClose = document.getElementById('btnClose');

  function setStatus(text, cls){
    statusEl.textContent = text;
    statusEl.className = 'badge ' + (cls || '');
  }

  function getTgId(){
    // 1) Telegram WebApp user.id
    const id1 = tg?.initDataUnsafe?.user?.id;
    if (id1) return Number(id1);

    // 2) URL param tg_id
    const params = new URLSearchParams(location.search);
    const id2 = params.get('tg_id');
    if (id2 && /^\d+$/.test(id2)) return Number(id2);

    return null;
  }

  async function api(path, body){
    return fetch(path, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body),
      // keepalive helps when closing quickly
      keepalive: true
    }).then(r => r.json());
  }

  let sessionId = null;
  let seconds = 15;
  let rewards = { tl: 0.25, dia: 0.25 };

  async function start(){
    const tgId = getTgId();
    if (!tgId){
      setStatus('Hata', 'err');
      adbox.textContent = 'Telegram kullanÄ±cÄ± bilgisi alÄ±namadÄ±.';
      info.innerHTML = '<span class="err">LÃ¼tfen bu sayfayÄ± bot iÃ§inden (WebApp) aÃ§.</span>';
      return;
    }

    setStatus('BaÅŸlÄ±yorâ€¦');
    const r = await api('/api/ad/start', { tg_id: tgId });
    if (!r.ok){
      setStatus('Hata', 'err');
      adbox.textContent = 'Reklam baÅŸlatÄ±lamadÄ±: ' + (r.error || 'server_error');
      return;
    }

    sessionId = r.session_id;
    seconds = Number(r.seconds) || 15;
    rewards = { tl: Number(r.reward_tl)||0.25, dia: Number(r.reward_diamonds)||0.25 };

    // SimÃ¼le reklam: sadece sayaÃ§. Ä°stersen buraya video/iframe koyarÄ±z.
    let left = seconds;
    setStatus(left + ' sn');
    adbox.textContent = 'Reklam oynatÄ±lÄ±yorâ€¦';

    const t = setInterval(async () => {
      left--;
      if (left <= 0){
        clearInterval(t);
        await complete();
      } else {
        setStatus(left + ' sn');
      }
    }, 1000);
  }

  async function complete(){
    const tgId = getTgId();
    setStatus('Ã–dÃ¼l ekleniyorâ€¦');
    adbox.textContent = 'Ã–dÃ¼l cÃ¼zdana iÅŸleniyorâ€¦';

    const r = await api('/api/ad/complete', { tg_id: tgId, session_id: sessionId });
    if (!r.ok){
      setStatus('Hata', 'err');
      adbox.textContent = 'Ã–dÃ¼l eklenemedi: ' + (r.error || 'server_error');
      info.innerHTML = '<span class="err">KapatÄ±p tekrar deneyebilirsin.</span>';
      return;
    }

    setStatus('Bitti', 'ok');
    adbox.textContent = 'âœ… Ã–dÃ¼l eklendi!';
    info.innerHTML = `<span class="ok">+${Number(r.tl_reward).toFixed(2)} TL ve +${Number(r.diamond_reward).toFixed(2)} Elmas cÃ¼zdanÄ±na eklendi.</span><br/>Telegram sohbetinde de mesaj gelecek.`;

    // Telegram'Ä±n request'i kesmemesi iÃ§in kÄ±sa bekle
    setTimeout(() => {
      try { tg?.close(); } catch(e){ window.close(); }
    }, 900);
  }

  btnClose.addEventListener('click', () => {
    try { tg?.close(); } catch(e){ window.close(); }
  });

  // auto start
  start().catch(err => {
    setStatus('Hata', 'err');
    adbox.textContent = 'Beklenmeyen hata: ' + (err?.message || err);
  });
})();
</script>
</body>
</html>
