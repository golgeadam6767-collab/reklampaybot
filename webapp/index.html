<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Reklam</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{margin:0;background:#0b1220;color:#e6eefc;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:520px;margin:0 auto;padding:14px}
    .card{background:#0f1b33;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .badge{background:#fbbf24;color:#111827;padding:6px 10px;border-radius:999px;font-weight:700}
    .adbox{margin-top:12px;height:220px;background:#000;border-radius:14px;display:flex;align-items:center;justify-content:center;color:#9aa7c2}
    .btn{margin-top:12px;width:100%;padding:12px 14px;border-radius:14px;border:0;font-weight:700}
    .btnClose{background:#e5e7eb;color:#111827}
    .muted{color:#9aa7c2;font-size:13px;line-height:1.4;margin-top:10px}
    .ok{color:#34d399}
    .err{color:#fb7185}
  
    .placeholder{padding:16px;color:#9aa7c2;font-size:14px;line-height:1.4;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div style="font-weight:800;font-size:18px">ðŸŽ¬ Reklam</div>
        <div id="status" class="badge">HazÄ±r</div>
      </div>

      <div class="adbox" id="adbox">Reklam otomatik baÅŸlayacakâ€¦</div>

      <div class="muted" id="info">
        Bu sayfa otomatik reklam iÃ§in kullanÄ±lÄ±r.<br/>
        SÃ¼re bitince Ã¶dÃ¼l cÃ¼zdanÄ±na eklenir ve sayfa kapanÄ±r.
      </div>

      <button class="btn btnClose" id="btnClose">Kapat</button>
    </div>
  </div>

<script>
  // Telegram WebApp helper
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
  }

  function getTgId() {
    const params = new URLSearchParams(location.search);
    const fromQuery = params.get('tg_id');
    if (fromQuery && /^[0-9]+$/.test(fromQuery)) return Number(fromQuery);
    const fromInit = tg?.initDataUnsafe?.user?.id;
    if (fromInit) return Number(fromInit);
    return null;
  }

  const tgId = getTgId();
  const statusEl = document.getElementById('status');
  const timerEl = document.getElementById('timer');
  const closeBtn = document.getElementById('closeBtn');
  const adFrame = document.getElementById('adFrame');
  const adBox = document.getElementById('adBox');

  let sessionId = null;
  let seconds = 15;
  let remaining = seconds;
  let tick = null;
  let completed = false;

  function setStatus(msg) {
    statusEl.textContent = msg;
  }

  function safeUrl(u) {
    try { return new URL(u).toString(); } catch { return null; }
  }

  function youtubeToEmbed(url) {
    try {
      const u = new URL(url);
      if (u.hostname.includes('youtu.be')) {
        const id = u.pathname.replace('/', '');
        return id ? `https://www.youtube.com/embed/${id}?autoplay=1&mute=1&controls=1` : null;
      }
      if (u.hostname.includes('youtube.com')) {
        const id = u.searchParams.get('v');
        return id ? `https://www.youtube.com/embed/${id}?autoplay=1&mute=1&controls=1` : null;
      }
    } catch {}
    return null;
  }

  function renderAd(ad) {
    // Default placeholder
    adFrame.src = 'about:blank';
    adFrame.style.display = 'none';

    if (!ad) {
      adBox.innerHTML = '<div class="placeholder">Reklam bulunamadÄ±. (Test modu)</div>';
      return;
    }

    const y = ad.youtube_url ? youtubeToEmbed(ad.youtube_url) : null;
    const direct = safeUrl(ad.page_url || ad.video_url || ad.target_url || '');

    // Adsense code usually needs JS; Telegram WebApp may block it. We'll show as note.
    if (ad.adsense_code && !y && !direct) {
      adBox.innerHTML = '<div class="placeholder">Bu reklam Google AdSense kodu iÃ§eriyor. Telegram iÃ§inde script engeli olabilir. (Panelden link/youtube eklemek daha sorunsuz)</div>';
      return;
    }

    // Prefer youtube embed, else iframe to link/page
    const src = y || direct;
    if (src) {
      adBox.innerHTML = '';
      adFrame.src = src;
      adFrame.style.display = 'block';
    } else {
      adBox.innerHTML = '<div class="placeholder">Reklam iÃ§eriÄŸi eksik. (link / youtube)</div>';
    }
  }

  async function start() {
    if (!tgId) {
      setStatus('Telegram kimliÄŸi alÄ±namadÄ±.');
      closeBtn.disabled = false;
      return;
    }

    setStatus('Reklam yÃ¼kleniyor...');
    closeBtn.disabled = false; // user can close anytime; reward only after full time

    const resp = await fetch('/api/ad/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tg_id: tgId })
    });

    const data = await resp.json().catch(() => ({}));
    if (!data.ok) {
      setStatus(data.error === 'daily_limit' ? 'GÃ¼nlÃ¼k limit doldu.' : ('BaÅŸlatma hatasÄ±: ' + (data.error || 'unknown')));
      return;
    }

    sessionId = data.session_id;
    seconds = Number(data.seconds) || 15;
    remaining = seconds;
    timerEl.textContent = remaining + ' sn';
    setStatus('Reklam oynatÄ±lÄ±yor...');

    renderAd(data.ad);

    tick = setInterval(async () => {
      remaining -= 1;
      if (remaining < 0) remaining = 0;
      timerEl.textContent = remaining + ' sn';

      if (remaining === 0) {
        clearInterval(tick);
        await complete();
      }
    }, 1000);
  }

  async function complete() {
    if (completed) return;
    completed = true;
    setStatus('Ã–dÃ¼l ekleniyor...');

    const resp = await fetch('/api/ad/complete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tg_id: tgId, session_id: sessionId })
    });

    const data = await resp.json().catch(() => ({}));
    if (data.ok) {
      setStatus('âœ… Reklam bitti! Ã–dÃ¼l cÃ¼zdanÄ±na eklendi.');
      // Close webapp after a short delay
      setTimeout(() => { tg?.close(); }, 800);
    } else {
      if (data.reason === 'too_early') {
        setStatus('â›” Reklam bitmeden Ã¶dÃ¼l verilmez. Kalan: ' + (data.remaining || '?') + ' sn');
      } else {
        setStatus('â›” Tamamlama hatasÄ±: ' + (data.error || data.reason || 'unknown'));
      }
    }
  }

  closeBtn.addEventListener('click', () => {
    // If user closes early, we do NOT call complete(). No reward.
    try { if (tick) clearInterval(tick); } catch {}
    tg?.close();
  });

  start();
</script>
</body>
</html>
