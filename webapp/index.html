<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ElmasToken â€¢ Reklam</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:#0f172a; color:#e2e8f0; }
    .wrap { max-width:520px; margin:0 auto; padding:14px 14px 24px 14px; }
    .card {
      background:#111827;
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 12px 24px rgba(0,0,0,.25);
    }
    .topbar {
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:#0b1220;
    }
    .title { font-weight:800; letter-spacing:.2px; }
    .pill {
      font-size:13px; font-weight:800;
      background:#fbbf24; color:#0b1220;
      padding:6px 10px; border-radius:999px;
      white-space:nowrap;
    }
    /* kÄ±rmÄ±zÄ± sÃ¼re Ã§ubuÄŸu (Ã¼stte, reklamÄ±n hemen altÄ±nda) */
    .progressWrap { height:8px; background:rgba(255,255,255,.08); }
    .progressBar { height:8px; width:0%; background:#ef4444; transition:width .25s linear; }

    video { width:100%; display:block; background:black; }
    .footer {
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .muted { color:#94a3b8; font-size:13px; }
    .btn {
      border:0; border-radius:12px; padding:10px 12px;
      font-weight:800; cursor:pointer;
      background:#e2e8f0; color:#0b1220;
    }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .ok { color:#a7f3d0; font-weight:700; }
    .err { color:#fecaca; font-weight:700; }
    .hint { margin-top:10px; font-size:13px; color:#94a3b8; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div class="title">ğŸ¬ Reklam</div>
        <div class="pill" id="pill">HazÄ±rlanÄ±yorâ€¦</div>
      </div>
      <div class="progressWrap"><div class="progressBar" id="bar"></div></div>

      <video id="vid" playsinline preload="auto"></video>

      <div class="footer">
        <div class="muted" id="status">Reklam hazÄ±rlanÄ±yorâ€¦</div>
        <button class="btn" id="closeBtn" disabled>Kapat</button>
      </div>
    </div>

    <div class="hint">
      Reklam otomatik baÅŸlar. SÃ¼re bitince Ã¶dÃ¼l eklenir ve sayfa otomatik kapanÄ±r.
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    const pill = document.getElementById('pill');
    const bar  = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const closeBtn = document.getElementById('closeBtn');
    const vid = document.getElementById('vid');

    let session_id = null;
    let durationSec = 0;
    let startedAt = 0;
    let ticker = null;

    function getTgId() {
      const id = tg?.initDataUnsafe?.user?.id;
      if (id) return Number(id);
      const p = new URLSearchParams(location.search);
      const uid = p.get('tg_id') || p.get('user_id');
      return uid ? Number(uid) : null;
    }

    async function postJSON(path, body) {
      const r = await fetch(path, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data?.reason || data?.error || ("HTTP " + r.status));
      return data;
    }

    function setProgress(pct) {
      const clamped = Math.max(0, Math.min(100, pct));
      bar.style.width = clamped.toFixed(2) + "%";
    }

    function setCountdown(rem) {
      pill.textContent = "SÃ¼re: " + rem + "s";
    }

    function stopTicker() {
      if (ticker) { clearInterval(ticker); ticker = null; }
    }

    async function completeAndClose() {
      try {
        statusEl.textContent = "Ã–dÃ¼l ekleniyorâ€¦";
        const tg_id = getTgId();
        await postJSON("/api/ad/complete", { tg_id, session_id });
        statusEl.innerHTML = '<span class="ok">âœ… Ã–dÃ¼l eklendi: +0.25 â‚º ve +0.25 ğŸ’</span>';
      } catch (e) {
        statusEl.innerHTML = '<span class="err">âŒ Ã–dÃ¼l yazÄ±lamadÄ±: ' + (e.message || e) + '</span>';
      } finally {
        closeBtn.disabled = false;
        setTimeout(() => {
          if (tg?.close) tg.close();
          else window.close();
        }, 1000);
      }
    }

    function startTimer(totalSec) {
      durationSec = Math.max(1, Math.floor(totalSec || 15));
      startedAt = Date.now();
      stopTicker();
      ticker = setInterval(() => {
        const elapsed = (Date.now() - startedAt) / 1000;
        const rem = Math.ceil(Math.max(0, durationSec - elapsed));
        const pct = (elapsed / durationSec) * 100;
        setProgress(pct);
        setCountdown(rem);
        if (rem <= 0) {
          stopTicker();
          completeAndClose();
        }
      }, 250);
    }

    async function startAdAuto() {
      const tg_id = getTgId();
      if (!tg_id) {
        statusEl.innerHTML = '<span class="err">âŒ Telegram iÃ§inde aÃ§malÄ±sÄ±n (tg_id alÄ±namadÄ±).</span>';
        pill.textContent = "Hata";
        closeBtn.disabled = false;
        return;
      }

      vid.muted = true;
      vid.controls = false;

      statusEl.textContent = "Reklam hazÄ±rlanÄ±yorâ€¦";
      pill.textContent = "YÃ¼kleniyorâ€¦";
      setProgress(0);

      const start = await postJSON("/api/ad/start", { tg_id });
      session_id = start.session_id;
      const ad = start.ad;

      const url = ad?.url;
      const sec = Number(ad?.seconds || 15);
      if (!url) throw new Error("Reklam bulunamadÄ±");

      vid.src = url;

      const playSafe = () => vid.play().catch(() => {});
      vid.addEventListener("loadedmetadata", () => {
        const vd = Number(vid.duration);
        if (Number.isFinite(vd) && vd > 0) startTimer(Math.ceil(vd));
        else startTimer(sec);
        playSafe();
      }, { once: true });

      vid.addEventListener("ended", () => {
        stopTicker();
        setProgress(100);
        setCountdown(0);
        completeAndClose();
      }, { once: true });

      playSafe();

      vid.addEventListener("click", () => {
        vid.muted = false;
        playSafe();
      });

      statusEl.textContent = "Reklam izleniyorâ€¦";
    }

    closeBtn.addEventListener("click", () => {
      if (tg?.close) tg.close();
      else window.close();
    });

    (async function boot(){
      try {
        const p = new URLSearchParams(location.search);
        const action = (p.get("action") || "").toLowerCase();
        const page = (p.get("page") || "").toLowerCase();
        if (action === "watch" || page === "watch") {
          await startAdAuto();
        } else {
          pill.textContent = "HazÄ±r";
          statusEl.textContent = "Bu sayfa otomatik reklam iÃ§in kullanÄ±lÄ±r.";
          closeBtn.disabled = false;
        }
      } catch (e) {
        stopTicker();
        pill.textContent = "Hata";
        statusEl.innerHTML = '<span class="err">âŒ ' + (e.message || e) + '</span>';
        closeBtn.disabled = false;
      }
    })();
  </script>
</body>
</html>
