<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CÃ¼zdan</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#0b1220;--card:#0f1a33;--text:#e6eefc;--muted:#9fb3d8;--border:#223055;}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{margin:0;background:linear-gradient(180deg,#071022,#0b1220);color:var(--text);min-height:100vh;padding:16px;}
    .card{max-width:520px;margin:0 auto;background:rgba(15,26,51,.92);border:1px solid var(--border);border-radius:18px;box-shadow:0 12px 32px rgba(0,0,0,.35);overflow:hidden;padding:16px;}
    h1{margin:0 0 10px;font-size:18px}
    .row{display:flex;gap:10px;margin-top:10px}
    .box{flex:1;background:#0a1123;border:1px solid var(--border);border-radius:14px;padding:14px}
    .k{color:var(--muted);font-size:12px}
    .v{font-weight:900;font-size:20px;margin-top:6px}
    .btn{width:100%;margin-top:14px;padding:14px;border-radius:14px;border:0;font-weight:800;font-size:16px;background:#e8eefc;color:#111;cursor:pointer}
    .err{margin-top:10px;color:#ffd2d2;background:rgba(255,59,48,.08);border:1px solid rgba(255,59,48,.35);padding:10px 12px;border-radius:14px;display:none}
  </style>
</head>
<body>
  <div class="card">
    <h1>ðŸ‘œ CÃ¼zdan</h1>
    <div class="row">
      <div class="box">
        <div class="k">TL</div>
        <div id="tl" class="v">â€”</div>
      </div>
      <div class="box">
        <div class="k">Elmas</div>
        <div id="d" class="v">â€”</div>
      </div>
    </div>
    <button id="close" class="btn">Kapat</button>
    <div id="err" class="err"></div>
  </div>

<script>
(function(){
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.expand(); tg.ready(); }
  const initData = tg ? tg.initData : "";
  const params = new URLSearchParams(location.search);
  const tgId = params.get("tg_id") || localStorage.getItem("tg_id");
      if (params.get("tg_id")) localStorage.setItem("tg_id", params.get("tg_id"));
  const tlEl = document.getElementById("tl");
  const dEl = document.getElementById("d");
  const err = document.getElementById("err");
  document.getElementById("close").onclick = ()=>{ if(tg) tg.close(); else window.close(); };

  async function api(path, body){
    // Telegram initData yoksa (bazÄ± masaÃ¼stÃ¼ durumlarÄ±) tg_id fallback ile oku
    if (!initData) {
      if (!tgId) throw new Error("missing_initData");
      const r = await fetch(`/api/wallet_public?tg_id=${encodeURIComponent(tgId)}&token=${encodeURIComponent(params.get('token')||'')}`);
      const j = await r.json().catch(()=>({ok:false,error:"bad_json"}));
      if(!r.ok || !j.ok) throw new Error(j.error || ("http_"+r.status));
      return j;
    }
    const r = await fetch(path, {
      method:"POST",
      headers: { "Content-Type":"application/json", "X-Telegram-InitData": initData },
      body: JSON.stringify(body || {})
    });
    const j = await r.json().catch(()=>({ok:false,error:"bad_json"}));
    if(!r.ok || !j.ok) throw new Error(j.error || ("http_"+r.status));
    return j;
  }

  (async()=>{
    try{
      const j = await api("/api/wallet", {});
      tlEl.textContent = Number(j.balance_tl).toFixed(2) + " â‚º";
      dEl.textContent = Number(j.diamonds).toFixed(2) + " ðŸ’Ž";
    }catch(e){
      err.style.display="block"; err.textContent = "Hata: " + e.message;
    }
  })();
})();
</script>
</body>
</html>
