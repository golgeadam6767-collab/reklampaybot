<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Reklam Ver</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#0b1220;--card:#0f1a33;--text:#e6eefc;--muted:#9fb3d8;--border:#223055;--ok:#34c759;--red:#ff3b30;}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{margin:0;background:linear-gradient(180deg,#071022,#0b1220);color:var(--text);min-height:100vh;padding:16px;}
    .card{max-width:560px;margin:0 auto;background:rgba(15,26,51,.92);border:1px solid var(--border);border-radius:18px;box-shadow:0 12px 32px rgba(0,0,0,.35);overflow:hidden;padding:16px;}
    h1{margin:0 0 6px;font-size:18px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:14px}
    label{display:block;font-size:12px;color:var(--muted);margin-top:10px;margin-bottom:6px}
    input,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0a1123;color:var(--text);outline:none}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px}
    .row>div{flex:1}
    .price{margin-top:10px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0a1123;color:var(--muted)}
    .btn{width:100%;margin-top:14px;padding:14px;border-radius:14px;border:0;font-weight:800;font-size:16px;background:#e8eefc;color:#111;cursor:pointer}
    .msg{margin-top:10px;padding:10px 12px;border-radius:14px;display:none}
    .ok{background:rgba(52,199,89,.10);border:1px solid rgba(52,199,89,.35);color:#d6ffdd}
    .err{background:rgba(255,59,48,.08);border:1px solid rgba(255,59,48,.35);color:#ffd2d2}
  </style>
</head>
<body>
  <div class="card">
    <h1>ðŸ“¢ Reklam Ver</h1>
    <div class="sub">1 saniye = 0.10 TL. SÃ¼re girince toplam tutar otomatik hesaplanÄ±r.</div>

    <label>BaÅŸlÄ±k (opsiyonel)</label>
    <input id="title" placeholder="Ã–rn: UygulamamÄ± indir" />

    <div class="row">
      <div>
        <label>SÃ¼re (sn)</label>
        <input id="seconds" type="number" min="3" max="300" value="10" />
      </div>
      <div>
        <label>GÃ¶sterim BaÅŸÄ± Tutar</label>
        <div id="price" class="price">â€”</div>
      </div>
    </div>

    
  <div class="row" style="margin-top:12px;">
    <div>
      <label>GÃ¶sterim (adet)</label>
      <input id="maxClicks" type="number" min="1" step="1" value="500" />
      <small style="opacity:.7">ReklamÄ±nÄ±zÄ±n kaÃ§ kez gÃ¶sterileceÄŸini girin. (Ã–rn: 500)</small>
    </div>
    <div>
      <label>Toplam BÃ¼tÃ§e</label>
      <input id="totalBudget" type="text" readonly />
    </div>
  </div>

<label>Video URL (mp4) (opsiyonel)</label>
    <input id="media_url" placeholder="https://.../video.mp4" />

    <label>YouTube linki (opsiyonel)</label>
    <input id="youtube_url" placeholder="https://youtu.be/..." />

    <label>Oyun linki (opsiyonel)</label>
    <input id="game_url" placeholder="https://..." />

    <label>Sayfa linki (opsiyonel)</label>
    <input id="page_url" placeholder="https://..." />

    <label>Google AdSense kodu (opsiyonel)</label>
    <textarea id="adsense_code" placeholder="<script>...</script>"></textarea>

    <button id="send" class="btn">ReklamÄ± Kaydet</button>
    <button id="close" class="btn" style="margin-top:10px;background:#1a2b55;color:#e6eefc;border:1px solid var(--border)">Kapat</button>

    <div id="msg" class="msg"></div>
  </div>

<script>
(function(){
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.expand(); tg.ready(); }
  const initData = tg ? tg.initData : "";

  const secondsEl = document.getElementById("seconds");
  const maxClicksEl = document.getElementById("maxClicks");
  const totalBudgetEl = document.getElementById("totalBudget");
  const priceEl = document.getElementById("price");
  const msg = document.getElementById("msg");
  const PRICE_PER_SECOND = 0.10;

  function updatePrice(){
    const s = Math.max(3, Math.min(300, parseInt(secondsEl.value || "10", 10) || 10));
    const p = (s * PRICE_PER_SECOND).toFixed(2);
    priceEl.textContent = p + " â‚º";

    const maxClicks = Math.max(1, Math.min(1000000, parseInt(maxClicksEl?.value || "1", 10) || 1));
    if (maxClicksEl) maxClicksEl.value = String(maxClicks);
    if (totalBudgetEl) {
      const v = (s * PRICE_PER_SECOND * maxClicks).toFixed(2) + " â‚º";
      // totalBudgetEl is an <input>, so set .value; fallback to textContent for safety
      if ("value" in totalBudgetEl) totalBudgetEl.value = v;
      else totalBudgetEl.textContent = v;
    }
  }
  secondsEl.addEventListener("input", updatePrice);
  if (maxClicksEl) maxClicksEl.addEventListener("input", updatePrice);
  updatePrice();

  function show(type, text){
    msg.style.display="block";
    msg.className = "msg " + (type==="ok" ? "ok" : "err");
    msg.textContent = text;
  }

  async function api(path, body){
    const r = await fetch(path, {
      method:"POST",
      headers: { "Content-Type":"application/json", "X-Telegram-InitData": initData },
      body: JSON.stringify(body || {})
    });
    const j = await r.json().catch(()=>({ok:false,error:"bad_json"}));
    if(!r.ok || !j.ok) throw new Error(j.error || ("http_"+r.status));
    return j;
  }

  document.getElementById("close").onclick = ()=>{ if(tg) tg.close(); else window.close(); };

  document.getElementById("send").onclick = async ()=>{
    try{
      const payload = {
        title: document.getElementById("title").value || "",
        seconds: Number(secondsEl.value || 10),
        max_clicks: Number(maxClicksEl?.value || 0) || 0,
        media_url: document.getElementById("media_url").value || "",
        youtube_url: document.getElementById("youtube_url").value || "",
        game_url: document.getElementById("game_url").value || "",
        page_url: document.getElementById("page_url").value || "",
        adsense_code: document.getElementById("adsense_code").value || ""
      };
      // Admin panel uses the authenticated admin ads endpoint
      const j = await api("/api/admin/ads", payload);

      const s = Math.max(1, Number(payload.seconds||0));
      const perView = s * PRICE_PER_SECOND;
      const maxClicks = Number(payload.max_clicks||0) || 0;
      const total = maxClicks > 0 ? (perView * maxClicks) : null;

      const maxInfo = maxClicks > 0 ? (" | GÃ¶sterim: " + maxClicks) : "";
      const totalInfo = total !== null ? (" | Toplam: " + total.toFixed(2) + " â‚º") : "";
      show("ok", "âœ… Reklam kaydedildi. ID: " + (j.ad?.id ?? "-") + " | 1 GÃ¶sterim: " + perView.toFixed(2) + " â‚º" + maxInfo + totalInfo);
    }catch(e){
      show("err", "Hata: " + e.message);
    }
  };
})();
</script>
</body>
</html>
